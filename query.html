<!DOCTYPE html>
<html>
<head>

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<!--<script src="static/js/jquery.min.js"></script>-->

<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet">
<!--<link rel="stylesheet" type="text/css" href="static/css/bootstrap.min.css">-->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<!--<script src="static/js/bootstrap.min.js"></script>-->

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<!--<link rel="stylesheet" type="text/css" href="static/css/font-awesome.min.css">-->

<!--<link rel="stylesheet" type="text/css" href="static/css/jquery.dataTables.css">-->
<script src="//cdn.datatables.net/1.10.3/js/jquery.dataTables.min.js"></script>
<!--<script src="static/js/jquery.dataTables.min.js"></script>-->

<script src="static/js/purl.min.js"></script>

<script src="static/js/moment.min.js"></script>

<script src="static/js/jquery.cookie.min.js"></script>

<script src="static/js/jquery.bootstrap-growl.min.js"></script>

<script src="static/js/bootbox.min.js"></script>

<link rel="stylesheet" type="text/css" href="static/css/dataTables.bootstrap.min.css">
<script src="static/js/dataTables.bootstrap.min.js"></script>

<link rel="stylesheet" type="text/css" href="static/css/bootstrap-datetimepicker.min.css">
<script src="static/js/bootstrap-datetimepicker.min.js"></script>

<link rel="stylesheet" type="text/css" href="css/main.css">
<script src="js/main.js"></script>

<style>
.table tr td {
    vertical-align: middle;
    height: 22px;
}

#indexed.block {
    display: none;
}
</style>

<script type="text/javascript">
$(document).ready(function() {
    $.getJSON("hosts.json", function(hosts) {
        var token = $.cookie("token");

        var db = $.url().param('db');
        if (db == null) {
            window.location.href = '/';
        }

        var host = hosts[db].host;
        var dbName = hosts[db].name;

        $("#dbName").text("-- " + dbName);
        document.title = "GeNA Miner -- " + dbName;

        var jsonp = hosts[db].jsonp;

        var minPeriod = hosts[db].minPeriod;
        var momentFormat = hosts[db].dateTimeFormat;

        var table = $("#example").DataTable( {
            "ajax": {
                "url": "http://" + host + "/history/load?token=" + token,
                "dataType": (jsonp ? "jsonp" : "json"),
                "jsonpCallback": "jsonpcallback",
            },

            "deferRender": true,
            "paging": false, 
            "searching": false,
            "ordering": false,
            "scrollY": "400px",
            "scrollCollapse": true,

            "columns": [
                {
                    "width": "250px", 
                    "data": "query",
                    "orderable": false
                },
                {
                    "width": "100px", 
                    "data": "stat",
                    "orderable": false 
                },
                {
                    "width": "50px", 
                    "orderable": false,
                    "defaultContent": '<button style="display: none;" class="btn btn-danger btn-xs"><span class="fa fa-trash-o"></span> Delete</button>'
                }
            ]
        });

        $('#example tbody').on('click', 'tr', function () {
            $('tr.active').removeClass("active");
            $(this).addClass('active');

            $("#query").val(table.row($(this)).data()["query"]);
        });

        $('#example tbody').on('click', 'button', function () {
            var data = table.row($(this).parents('tr')).data();
            var query = data["query"];
            bootbox.dialog({
                message: '\
                    Are you sure you want to delete indexed query <b>' + query + '</b>?<br/><br/>\
                    <div class="panel panel-default">\
                        <div class="panel-body">\
                            <div class="form-inline">\
                                <label class="control-label">Query:</label> <input id="deleteConfirm"type="text" class="form-control input-sm" style="width:250px"></input>\
                            </div>\
                        </div>\
                        <div class="panel-footer">\
                            <span class="help-block">Enter the exact query name to confirm. </span>\
                        </div>\
                    </div>\
                    ',
                title: "Confirm",
                onEscape: function() {},
                buttons: {
                    cancel: {
                        label: "Cancel",
                        className: "btn-default"
                    },
                    danger: {
                        label: '<span class="fa fa-trash-o"></span> Delete',
                        className: "btn-danger",
                        callback: function() {
                            if ($("input#deleteConfirm").val() != query) {
                                showAlert("You did not enter the correct indexed query name.", "warning");
                            }
                            else {
                                $.getJSON("http://" + host + "/history/delete?callback=?&token=" + token, 
                                    {
                                        "query": query
                                    }, 
                                    function(j){
                                        table.ajax.reload();
                                        showAlert("Indexed query <b>"+ query + "</b> has been deleted.", "info");
                                    }
                                );
                            }
                        }
                    }
                }
            });
        });

        $("input[name='db']").val(db);

        if (minPeriod == "year") {
            $(".input-date").css("width", "50px");

            $('#from').val(moment().subtract(10, "years").format(momentFormat));
            $('#to').val(moment().subtract(1, "years").format(momentFormat));

            $('#from').attr("title", $('#from').attr("title") + (" 1900"));
            $('#to').attr("title", $('#to').attr("title") + (" last year"));
        }
        else if (minPeriod == "second") {
            $(".input-date").css("width", "140px");

            //$('#from').val(moment().startOf('day').subtract(1, "months").format(momentFo*/
            $('#from').val("2014-11-21 20:00:00");
            $('#to').val(moment().utc().endOf('hour').subtract(2, "hours").format(momentFormat));

            $('#from').attr("title", $('#from').attr("title") + (" least recent available time"));
            $('#to').attr("title", $('#to').attr("title") + (" last second of two hours ago"));
        }

        $('.input-date').datetimepicker({
            format: momentFormat
        });

        var allowEmptyQuery = hosts[db].allowEmptyQuery;
        if (allowEmptyQuery) {
            $("#query").attr("title", "Empty query matchs all records")
        }
        else {
            $("#query").attr("title", "At least one keyword")
        }

        $(".breadcrumb [title]").tooltip({placement: "bottom", html: true, container: 'body'});
        $("[title]").tooltip({placement: "top", html: true, container: 'body', trigger: "focus"});
        table.on('draw.dt', function () {
            if ($("div.dataTables_scrollBody").prop("scrollHeight") > $("div.dataTables_scrollBody").height()) {
                $(".dataTables_scroll").attr("title", "Scroll to see more entries").attr("data-trigger", "manual").tooltip({placement: "bottom", html: true, container: 'body'}).tooltip("show");
            }
        } );

        $("#query").on("input", function() {
            if (this.value !== table.$("tr.active").val()) {
                table.$('tr.active').removeClass('active');
            }
        });

        $('#query_form').submit( function(e) {
            if (!allowEmptyQuery && !isNotEmpty($('#query').val())) {
                showAlert("Please check your <b>query</b> input.", "danger");
                $("#query").tooltip("show");
                $("#query_form").addClass("has-error");
                e.preventDefault();
                return;
            }
            else {
                $("#query").tooltip("hide");
            }

            /*
            if (!isIntWithMinVal($('#from').val(), 1900)) {
                showAlert("Please check your <b>start year</b> input.", "danger");
                $("#from").tooltip("show");
                $("#query_form").addClass("has-error");
                e.preventDefault();
                return;
            }
            if (!isIntWithMaxVal($('#to').val(), new Date().getFullYear() - 1)) {
                showAlert("Please check your <b>end year</b> input.", "danger");
                $("#to").tooltip("show");
                $("#query_form").addClass("has-error");
                e.preventDefault();
                return;
            }
            if (parseInt($('#from').val()) > parseInt($('#to').val())) {
                showAlert("Please check your <b>start year</b> and <b>end year</b> inputs.", "danger");
                $("#from").tooltip("show");
                $("#to").tooltip("show");
                $("#query_form").addClass("has-error");
                e.preventDefault();
                return;
            }
            */
        } );

        $("#manage").change(function() {
            if (this.checked) {
                $(".table tr td button").fadeIn(200);
            }
            else {
                $(".table tr td button").fadeOut(200);
            }
        });

        if (hosts[db].showIndexed) {
            $("#indexed.block").show();
        }
    });
});
</script>
</head>
<body>
<ol class="breadcrumb">
    <li><a href="/"><span class="fa fa-home" title="Home"></span></a></li>
    <li class="active">Query</li>
</ol>

<div class="beta-ribbon-wrapper"><div class="beta-ribbon"><a href="http://www.genalab.org/">GeNA Lab</a></div></div>
<div class="container-fluid">
    <h3>GeNA Miner <small id="dbName"></small></h3>
<div style="max-width:800px;">
    <div class="block">
        <form class="form-inline" id="query_form" action="records.html" method="get">
            <input type="hidden" name="db">
            <label class="control-label">Query: </label>
            <input class="form-control input-sm" id="query" style="width:250px;" name="query">
            <label class="control-label">Period: </label>
            <div class='input-group'>
                <input class="form-control input-sm input-date" id="from" style="width:50px;" name="from" title="Greater than or equal to ">
            </div>
            -
            <div class='input-group'>
                <input class="form-control input-sm input-date" id="to" style="width:50px;" name="to" title="Less than or equal to ">
            </div>
            <button class="btn btn-primary btn-sm" id="load" type="submit"><span class="fa fa-rocket"></span> Load</button>
        </form>
    </div>
    <div class="block" id="indexed">
        <table style="width:100%; ">
            <tr>
                <td>
                    <label class="control-label">Indexed Query: </label>
                </td>
                <td style="text-align:right;">
                    <div class="btn-group" data-toggle="buttons">
                        <label class="btn btn-default btn-sm"><span class="fa fa-pencil-square-o"></span> Edit<input type="checkbox" id="manage"></label>
                    </div>
                </td>
            </tr>
        </table>
        <table id="example" class="table table-hover" style="width:100%;" >
            <thead>
                <tr>
                    <th>Query</th>
                    <th>Indexed</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

</div>
</body>
</html>

